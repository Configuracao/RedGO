<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda Deportiva - CineFlixter</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES DE TEMA OSCURO (CineFlixter) --- */
        :root {
            --main-red: #E50914; 
            --background-color: #000000; 
            --surface-color: #1f1f1f;
            --text-color: #ffffff;
            --border-color: #444;
            --menu-text-secondary: #aaa;
            --menu-divider: #383838;
        }

        /* --- ESTILOS GENERALES Y ESTRUCTURA --- */
        body, html {
            margin: 0; padding: 0; 
            font-family: 'Manrope', sans-serif;
            background-color: var(--background-color); 
            color: var(--text-color);
            line-height: 1.4;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 15px;
        }

        h1#title-agenda {
            text-align: center;
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--text-color);
            margin: 10px 0 20px;
        }

        /* Controles (Búsqueda y Filtro) */
        .controls-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .controls-bar input, .controls-bar select {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-color);
            font-size: 1rem;
            -webkit-appearance: none;
            cursor: pointer;
        }
        
        .controls-bar option {
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Contenedor de la Lista */
        ul#menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        /* Icono de Play en el submenú (para que el color sea Rojo) */
        .submenu-item li img[alt="play"] {
            filter: hue-rotate(300deg) brightness(1.5); 
        }
        
        /* Indicador de carga */
        .loading-message {
            text-align: center;
            color: var(--menu-text-secondary);
            padding: 40px;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1 id="title-agenda">Agenda</h1>
        
        <div class="controls-bar">
            <input type="search" id="search" placeholder="Buscar partido..." autocomplete="off">
            <select id="filter_category">
                <option value="">-- Filtra por Categoria --</option>
            </select>
        </div>

        <ul id="menu">
            <p class="loading-message">Cargando agenda...</p>
        </ul>
    </div>

    <script>
        $ = jQuery;

        // --- CONFIGURACIÓN Y CONSTANTES ---
        const AGENDA_URL = "https://golazoplay.com/agenda.json";
        const IMG_BASE_URL = "https://img.golazoplay.com";
        const CATEGORIES_PERMITTED = ['futbol', 'tennis', 'basketball', 'wwe', 'mma(ufc)', 'formula1', 'boxing'];
        // Zona Horaria de origen del JSON (ajusta si es necesario)
        const SOURCE_TIMEZONE = "America/Lima"; 
        
        // --- VARIABLES DE TEMA USADAS EN EL TEMPLATE ---
        const THEME_MAIN_RED = "#E50914";     
        const THEME_SURFACE_COLOR = "#1f1f1f"; 
        const THEME_TEXT_COLOR = "#ffffff";   
        const THEME_TEXT_SECONDARY = "#aaa";  
        const THEME_BORDER_COLOR = "#383838"; 

        document.addEventListener('DOMContentLoaded', function() {
            obtenerAgenda();

            $(document).on("click", ".submenu-item", function (event) {
                event.stopPropagation();
            });

            $(document).on("click", ".toggle-submenu", function () {
                var $submenuElement = $(this).closest('li').find('ul');

                if (!$submenuElement.is(":visible"))
                {
                    $(".toggle-submenu").not(this).closest('li').find('ul').slideUp();
                    $submenuElement.slideDown();
                } else {
                    $submenuElement.slideUp();
                }
            });

            setInterval(upgrade, 60000); 

            window.scrollTo({ top: 0, behavior: 'smooth' });

            /********** SCRIPT SEARCH FILTER **********/
            let search = document.getElementById('search');

            search.addEventListener('keyup', () => {
                let filter = search.value.toLowerCase();
                let streamLinks = document.querySelectorAll("#menu > li");

                if(filter === '') {
                    streamLinks.forEach(link => link.style.display = 'block');
                    return;
                }

                streamLinks.forEach(link => {
                    let title = link.querySelector('div > div > span').textContent.toLowerCase();

                    if (title.includes(filter)) {
                        link.style.display = '';
                    } else {
                        link.style.display = 'none';
                    }
                });
            });

            search.addEventListener("search", function(event) {
                event.preventDefault();
                obtenerAgenda(); 
            });

            /********** SCRIPT SELECTED CATEGORY FILTER **********/

            let searchByCategory = document.getElementById('filter_category');

            searchByCategory.addEventListener('change', function() {
                let filter = this.value.toLowerCase();
                let streamLinks = document.querySelectorAll("#menu > li");

                streamLinks.forEach(link => {
                    const category = link.getAttribute('data-category').toLowerCase();

                    if (filter === '' || category.includes(filter)) {
                        link.style.display = '';
                    } else {
                        link.style.display = 'none';
                    }
                });
            });
        });

        function upgrade() {
            refrescarAgenda();
        }

        // --- FUNCIONES DE MANEJO DE HORA Y FECHA (CORREGIDAS) ---

        /**
         * @function convertToUserTimeZone
         * Convierte la hora de la agenda (en SOURCE_TIMEZONE) a la hora local del usuario.
         */
        function convertToUserTimeZone(dateString, timeString) {
            const DateTime = luxon.DateTime;
            
            // Combina la fecha y hora de la agenda en el formato ISO 8601 esperado
            const combinedDateTime = `${dateString}T${timeString}`;
            
            // Crea un objeto DateTime con la hora y la zona de origen
            const sourceDateTime = DateTime.fromISO(combinedDateTime, { zone: SOURCE_TIMEZONE });
            
            // Convierte a la zona horaria local del usuario y formatea
            const localDateTime = sourceDateTime.toLocal();
            
            return localDateTime.toFormat("HH:mm");
        }
        
        /**
         * @function formatDate
         * CORREGIDO: Usa Luxon para formatear la fecha actual de forma segura y en español.
         */
        function formatDate(dateString) {
            const DateTime = luxon.DateTime;
            // Asume que dateString es el ISO de la fecha actual (new Date().toISOString())
            const dt = DateTime.fromISO(dateString, { locale: 'es' });
            // Formato robusto: "27 de noviembre de 2025"
            return dt.toFormat("d 'de' MMMM 'de' yyyy");
        }

        // --- FUNCIONES DE CARGA Y RENDERIZADO ---

        function buildAgendaHtml(data) {
             return data
                .filter(value => CATEGORIES_PERMITTED.includes(value.attributes.deportes.toLowerCase()))
                .map(value => {
                    const imageUrl = value.attributes.country.data
                        ? IMG_BASE_URL + value.attributes.country.data.attributes.image.data.attributes.url
                        : "https://img.golazoplay.com/uploads/sin_imagen_d36205f0e8.png";
                    
                    // Conversión a la hora local del usuario
                    const localTime = convertToUserTimeZone(value.attributes.date_diary, value.attributes.diary_hour);

                    const submenuHtml = value.attributes.embeds.data.map(embed => {
                        if (embed) {
                            let urlComplete = embed.attributes.embed_iframe || "/star-plus";
                            return `
                                <div class="submenu" style="padding-top:8px">
                                    <a href="${urlComplete}" style="font-size: 0.875rem; color: ${THEME_TEXT_SECONDARY}; text-decoration: none; transition: color 0.3s;" class="submenu-item">
                                        <li style="padding-bottom: 0.5rem; padding-top: 0.5rem; width: 100%; display: flex; align-items: center; list-style: none; border-bottom: 1px dashed ${THEME_BORDER_COLOR};">
                                            <img src="https://img.icons8.com/?size=10&id=59862&format=png&color=E50914" style="margin-right: 0.5rem; height: 10px; width: 10px;" alt="play">
                                            <span style="font-family: arial, Arial, Helvetica, sans-serif; font-size: 15px;">${embed.attributes.embed_name}</span>
                                        </li>
                                    </a>
                                </div>
                            `;
                        }
                        return '';
                    }).join('');

                    return `
                        <li class="toggle-submenu" 
                            style="padding: 0.75rem; border-radius: 8px; cursor: pointer; list-style: none; margin-bottom: 10px; background-color: ${THEME_SURFACE_COLOR}; border-left: 3px solid ${THEME_MAIN_RED};" 
                            data-category="${value.attributes.deportes.toLowerCase()}">
                            
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center;">
                                    <time datetime="${localTime}" 
                                          style="width: 3rem; text-align: center; font-weight: 700; font-size: 15px; color: ${THEME_MAIN_RED};">
                                        ${localTime}
                                    </time>
                                    <img src="${imageUrl}" alt="" style="margin-left: 0.5rem; object-fit: cover; height: 1.5rem; width: 1.5rem;">
                                    <span style="flex: 1; margin-left: 1rem; text-align: left; font-weight: 700; color: ${THEME_TEXT_COLOR}; font-family: arial, Arial, Helvetica, sans-serif;font-size: 15px;">
                                        ${value.attributes.diary_description}
                                    </span>
                                </div>
                                <span style="margin-left: 0.5rem; color: ${THEME_TEXT_SECONDARY};"></span>
                            </div>
                            
                            <ul style="margin-left: 1rem; border-radius: 0.5rem; display: none; padding-top: 5px;">
                                ${submenuHtml}
                            </ul>
                        </li>
                    `;
                }).join('');
        }

        async function obtenerAgenda() {
            const menuElement = document.getElementById("menu");
            const titleAgendaElement = document.getElementById("title-agenda");
            
            menuElement.innerHTML = '<p class="loading-message">Cargando agenda...</p>';

            try {
                // Fetch con anti-caché
                const response = await fetch(`${AGENDA_URL}?t=${new Date().getTime()}`);
                
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo acceder a la URL de la agenda.`);
                }
                
                const result = await response.json();

                loadCategories(result.data);
                
                // La fecha ahora se formatea correctamente usando Luxon
                const dateCompleted = formatDate(new Date().toISOString());
                titleAgendaElement.innerHTML = "Agenda - " + dateCompleted;

                const data = result.data.sort((a, b) =>
                    a.attributes.diary_hour.localeCompare(b.attributes.diary_hour)
                );

                const html = buildAgendaHtml(data);
                
                if (html.length === 0) {
                     menuElement.innerHTML = `<p class="loading-message">No hay eventos disponibles en las categorías permitidas.</p>`;
                } else {
                     menuElement.innerHTML = html;
                }
               
            } catch (error) {
                console.error("Error fetching agenda:", error);
                menuElement.innerHTML = `<p class="loading-message" style="color:${THEME_MAIN_RED};">
                    <strong>¡Error de carga!</strong>
                    No se pudieron obtener los datos de la agenda. 
                    <br>(${error.message}).</p>`;
            }
        }

        async function refrescarAgenda() {
            await obtenerAgenda();
        }

        function loadCategories(data) {
            let filter_category = document.getElementById('filter_category');
            if (!filter_category) return;
            
            let categoryArray = [];
            data.forEach(item => {
                const category = item.attributes.deportes.toLowerCase();
                if (CATEGORIES_PERMITTED.includes(category) && !categoryArray.includes(category)) {
                    categoryArray.push(category);
                }
            });

            if(categoryArray.length > 0) {
                let html = '  <option value="">-- Filtra por Categoria --</option>';
                categoryArray.forEach(category => {
                    html += `<option value="${category}">${category.toUpperCase()}</option>`;
                });
                filter_category.innerHTML = html;
            }
        }
    </script>
</body>
</html>