<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>360TV - Guía de Canales</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cal+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cal Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #000000;
            color: #333;
        }

        .app {
            max-width: 600px;
            margin: 0 auto;
            background: #000000;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 0.5rem;
            background: #000000;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tabs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            padding: 0;
            gap: 0.5rem;
        }

        .tab {
            background: none;
            border: none;
            color: white;
            opacity: 0.7;
            padding: 0.75rem;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tab.active {
            opacity: 1;
            font-weight: bold;
            border-bottom: 2px solid #ff0000;
            color: #ff0000;
        }

        .channel-list {
            flex: 1;
            padding: 1rem;
            padding-bottom: calc(1rem + 65px);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 0;
        }

        .channel-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            text-decoration: none;
            color: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .channel {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #121212;
            border-radius: 8px;
            color: white;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.3s ease, transform 0.3s ease;
            height: 92px;
        }

        .channel:hover {
            background: #1a1a1a;
        }

        .channel:active {
            background: #252525;
            transform: scale(0.98);
        }

        .channel-logo {
            width: 60px;
            height: 60px;
            flex-shrink: 0;
            background: #efefef;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .channel-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 5px;
        }

        .program-info {
            flex: 1;
            min-width: 0;
        }

        .current, .next {
            display: flex;
            gap: 0.5rem;
            margin: 0.15rem 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .title {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .next {
            opacity: 0.7;
            font-size: 0.75rem;
        }

        .bottom-nav {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            padding: 0;
            background: #000000;
            border-top: 1px solid #222;
            gap: 0;
            width: 100%;
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            max-width: 600px;
            z-index: 900;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.75rem 0.5rem;
            background: none;
            border: none;
            color: #666;
            font-size: 0.8rem;
            cursor: pointer;
            width: 100%;
            text-align: center;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .nav-item.active {
            color: #ff0000;
        }
        
        .nav-item .icon {
            font-size: 24px;
        }

        .nav-item span {
            font-size: 0.8rem;
            margin-top: 0.25rem;
        }

        .bottom-nav svg {
            width: 24px; 
            height: 24px;
        }

        .favorite-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: #666;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .favorite-btn.active {
            color: #ff0000;
        }
        
        .favorite-btn svg path {
            transition: fill 0.2s ease;
        }

        .iframe-overlay, .search-overlay, .movies-overlay, .report-error-overlay, .notifications-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000000;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .search-header, .iframe-header {
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            background: #121212;
            flex-shrink: 0;
        }
        
        .back-btn {
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
            color: white;
            display: flex;
        }
        
        .back-btn svg {
            width: 24px;
            height: 24px;
        }

        .channel-title {
            flex: 1;
            text-align: left;
            margin: 0;
            color: white;
            font-size: 1.2rem;
        }
        
        .iframe-content {
            flex: 1;
            position: relative;
            width: 100%;
            height: calc(100vh - 72px); /* Adjust based on header height */
        }

        #mainContent {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            visibility: hidden; /* Oculto hasta que cargue */
        }
        
        .channel-list-loader, .iframe-loader {
            border: 6px solid #333; /* Gris oscuro para el rastro */
            border-top: 6px solid #ff0000; /* Rojo para la parte que gira */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .channel-list-loader {
            margin: 40px auto; /* Centrado en la lista de canales */
        }

        .iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .iframe-loader-container {
             position: absolute;
             top: 50%;
             left: 50%;
             transform: translate(-50%,-50%);
        }

        .notifications-content {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background: #121212;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .notification-details {
            flex: 1;
        }

        .notification-details h3 {
            color: white;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .notification-details p {
            color: #999;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }

        .notification-time {
            color: #666;
            font-size: 0.8rem;
        }
        
        .notification-icon {
            display: flex;
            align-items: flex-start;
            padding-top: 0.25rem;
        }

        /* Y el resto de tus estilos para los otros overlays... */
        
    </style>
</head>
<body>
    <div class="app">
        <header>
            <div class="tabs">
                <button class="tab active" data-tab="todos">Canales</button>
                <button class="tab" data-tab="favoritos">Favoritos</button>
            </div>
        </header>

        <!-- El contenido se generará aquí dinámicamente -->
        <main class="channel-list">
            <div class="channel-list-loader"></div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="2" y="7" width="20" height="15" rx="2" ry="2"></rect>
                    <polyline points="17 2 12 7 7 2"></polyline>
                </svg>
                <span>Canales</span>
            </button>
            <!-- Aquí puedes añadir los otros botones de navegación si los necesitas -->
            <button class="nav-item" id="notificationsBtn">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span>Notificaciones</span>
            </button>
        </nav>

        <!-- Iframe Overlay modificado con loader -->
        <div class="iframe-overlay" style="display: none;">
            <div class="iframe-header">
                <button class="back-btn iframe-back-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </button>
                <h2 class="section-title channel-title">Canal</h2>
            </div>
            <div class="iframe-content">
                <div class="iframe-loader-container">
                    <div class="iframe-loader" style="display: none;"></div>
                </div>
                <iframe 
                    id="mainContent" 
                    allow="encrypted-media"
                    allowfullscreen=""
                    frameborder="0"
                    sandbox="allow-same-origin allow-scripts"
                    scrolling="no"
                    src=""
                    style="border: none;"
                ></iframe>
            </div>
        </div>

        <!-- Notifications Overlay -->
        <div class="notifications-overlay" style="display: none;">
            <div class="iframe-header">
                <button class="back-btn notifications-back-btn">
                     <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                </button>
                <h2 class="section-title">Notificaciones</h2>
            </div>
            <div class="notifications-content">
                <!-- Las notificaciones se cargarán aquí -->
            </div>
        </div>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- SELECTORES DE ELEMENTOS ---
        const channelListContainer = document.querySelector('.channel-list');
        const notificationsContent = document.querySelector('.notifications-content');
        const iframeOverlay = document.querySelector('.iframe-overlay');
        const mainContentIframe = document.getElementById('mainContent');
        const iframeLoader = document.querySelector('.iframe-loader');
        const channelTitle = document.querySelector('.channel-title');
        const iframeBackBtn = document.querySelector('.iframe-back-btn');
        const tabs = document.querySelectorAll('.tab');
        const notificationsBtn = document.getElementById('notificationsBtn');
        const notificationsOverlay = document.querySelector('.notifications-overlay');
        const notificationsBackBtn = document.querySelector('.notifications-back-btn');

        // --- ESTADO DE LA APP ---
        let allChannels = [];
        let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');

        // --- ICONOS PARA NOTIFICACIONES (SVG) ---
        const icons = {
            success: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
            warning: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ffc107" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`,
            info: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2196F3" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>`
        };

        // --- CARGAR DATOS INICIALES DESDE data.json ---
        async function fetchData() {
            try {
                // Se añade un parámetro de tiempo para evitar que el navegador use una versión en caché del JSON
                const response = await fetch('data.json?v=' + new Date().getTime());
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                allChannels = data.channels;
                renderChannels(allChannels);
                renderNotifications(data.notifications);
            } catch (error) {
                console.error('Error al cargar data.json:', error);
                channelListContainer.innerHTML = '<p style="color:white; text-align:center;">Error al cargar los canales. Inténtalo de nuevo más tarde.</p>';
            }
        }

        // --- RENDERIZADO DE LA LISTA DE CANALES ---
        function renderChannels(channelsToRender) {
            channelListContainer.innerHTML = '';
            if (channelsToRender.length === 0) {
                 channelListContainer.innerHTML = '<p style="color:white; text-align:center; padding: 2rem 0;">No tienes canales en Favoritos.</p>';
                 return;
            }
            channelsToRender.forEach(channel => {
                const isFavorite = favorites.includes(channel.id);
                const channelHTML = `
                    <div class="channel" data-channel-id="${channel.id}">
                        <a href="#" class="channel-link" data-stream-url="${channel.streamUrl}" data-channel-name="${channel.name}">
                            <div class="channel-logo">
                                <img src="${channel.logo}" alt="${channel.name} Logo" loading="lazy">
                            </div>
                            <div class="program-info">
                                <div class="current">
                                    <span class="title">${channel.name}</span>
                                </div>
                                <div class="next">
                                    <span class="title">Ver ${channel.name} en vivo</span>
                                </div>
                            </div>
                        </a>
                        <button class="favorite-btn ${isFavorite ? 'active' : ''}">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="${isFavorite ? '#ff0000' : 'none'}" stroke="currentColor" stroke-width="2">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </button>
                    </div>`;
                channelListContainer.insertAdjacentHTML('beforeend', channelHTML);
            });
        }
        
        // --- RENDERIZADO DE LAS NOTIFICACIONES ---
        function renderNotifications(notifications) {
            notificationsContent.innerHTML = '';
            notifications.forEach(notif => {
                const date = new Date(notif.timestamp);
                const notificationHTML = `
                <div class="notification-item">
                    <div class="notification-icon">
                        ${icons[notif.icon] || icons['info']}
                    </div>
                    <div class="notification-details">
                        <h3>${notif.title}</h3>
                        <p>${notif.message}</p>
                        <span class="notification-time">${date.toLocaleString('es-ES', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' })}</span>
                    </div>
                </div>`;
                notificationsContent.insertAdjacentHTML('beforeend', notificationHTML);
            });
        }

        // --- MANEJO DE EVENTOS (DELEGACIÓN DE EVENTOS PARA EFICIENCIA) ---
        channelListContainer.addEventListener('click', function(e) {
            const channelLink = e.target.closest('.channel-link');
            const favoriteBtn = e.target.closest('.favorite-btn');

            if (channelLink) {
                e.preventDefault();
                const streamUrl = channelLink.dataset.streamUrl;
                const name = channelLink.dataset.channelName;
                openChannelPlayer(name, streamUrl);
            }

            if (favoriteBtn) {
                e.preventDefault();
                toggleFavorite(favoriteBtn);
            }
        });

        // --- ABRIR REPRODUCTOR DE CANAL CON LOADER ---
        function openChannelPlayer(name, url) {
            channelTitle.textContent = name;
            iframeOverlay.style.display = 'flex';
            iframeLoader.style.display = 'block';
            mainContentIframe.style.visibility = 'hidden';
            mainContentIframe.src = url; // Inicia la carga del iframe
        }

        // --- EVENTO "LOAD" DEL IFRAME PARA OCULTAR EL LOADER ---
        mainContentIframe.onload = function() {
            iframeLoader.style.display = 'none';
            mainContentIframe.style.visibility = 'visible';
        };

        // --- CERRAR EL REPRODUCTOR ---
        iframeBackBtn.addEventListener('click', function() {
            iframeOverlay.style.display = 'none';
            mainContentIframe.src = ''; // Detiene la reproducción y libera recursos
        });

        // --- GESTIÓN DE FAVORITOS ---
        function toggleFavorite(btn) {
            const channelElement = btn.closest('.channel');
            const channelId = channelElement.dataset.channelId;
            const index = favorites.indexOf(channelId);
            const svg = btn.querySelector('svg');
            
            if (index === -1) {
                favorites.push(channelId);
                btn.classList.add('active');
                svg.setAttribute('fill', '#ff0000');
            } else {
                favorites.splice(index, 1);
                btn.classList.remove('active');
                svg.setAttribute('fill', 'none');
            }
            localStorage.setItem('favorites', JSON.stringify(favorites));

            // Si estamos en la pestaña de favoritos, el canal desaparece con una animación
            if (document.querySelector('.tab.active').dataset.tab === 'favoritos' && index !== -1) {
                channelElement.style.opacity = '0';
                channelElement.style.transform = 'translateX(-100px)';
                setTimeout(() => {
                    filterFavorites();
                }, 300);
            }
        }
        
        // --- FILTRAR Y MOSTRAR SOLO CANALES FAVORITOS ---
        function filterFavorites() {
            const favoriteChannels = allChannels.filter(channel => favorites.includes(channel.id));
            renderChannels(favoriteChannels);
        }

        // --- MANEJO DEL CAMBIO DE PESTAÑAS (TABS) ---
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                const tabType = this.dataset.tab;
                if (tabType === 'favoritos') {
                    filterFavorites();
                } else {
                    renderChannels(allChannels);
                }
            });
        });

        // --- MANEJO DEL OVERLAY DE NOTIFICACIONES ---
        notificationsBtn.addEventListener('click', () => {
            notificationsOverlay.style.display = 'flex';
        });

        notificationsBackBtn.addEventListener('click', () => {
            notificationsOverlay.style.display = 'none';
        });

        // --- INICIAR LA APLICACIÓN ---
        fetchData();
    });
    </script>
</body>
</html>