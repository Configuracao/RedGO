<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Cargando...</title>
    
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reloaded') !== 'true') {
                urlParams.set('reloaded', 'true');
                window.location.search = urlParams.toString();
            }
        })();
    </script>

    <style>
        :root {
            /* PALETA VIBRANTE (Rojo más saturado para glow) */
            --main-red: #FF0033; 
            --background-color: #0A0A0A; /* Fondo más oscuro para contraste */
            --surface-color: #1A1A1A; /* Superficie/Modales/Bottom Sheets */
            --on-surface-color: #FFFFFF;
            --on-surface-variant-color: #BDBDBD;
            --border-color: #333333;
            --shine-color: rgba(255, 0, 51, 0.7); /* Color de resplandor neón */
            --main-accent-hover: #260008; /* Fondo sutil al pasar el mouse */
            --watched-color: #4CAF50; /* Color del checkmark de "Visto" */
        }

        body, html {
            margin: 0; padding: 0; font-family: 'Manrope', sans-serif;
            background-color: var(--background-color); color: var(--on-surface-color);
            line-height: 1.6;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        a { text-decoration: none; color: inherit; }

        .movie-banner {
            position: relative; min-height: 380px; display: flex; align-items: flex-end;
            gap: 20px; padding: 20px; background-size: cover; background-position: center 20%;
        }
        .movie-banner::after {
            content: ''; position: absolute; bottom: 0; left: 0;
            width: 100%; height: 100%;
            /* Gradiente más agresivo */
            background: linear-gradient(to top, var(--background-color) 0%, rgba(10, 10, 10, 0.8) 40%, transparent 100%);
            z-index: 1;
        }
        /* Nuevo: Glassmorphism sutil en la parte superior */
        .movie-banner::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            opacity: 0.05; z-index: 1;
        }
        
        .movie-poster, .movie-info, .top-action-button { position: relative; z-index: 2; }
        .movie-poster { flex-shrink: 0; width: 180px; }
        .movie-poster img { 
            width: 100%; border-radius: 12px; /* Bordes más modernos */
            box-shadow: 0 15px 50px rgba(0,0,0,0.8); /* Sombra más profunda */
            display: block; 
        }
        
        /* TÍTULO CON TEXT-SHADOW NEÓN */
        .movie-info h1 { 
            font-size: 2.5rem; 
            font-weight: 800; 
            margin: 0 0 12px 0; 
            color: var(--on-surface-color);
            text-shadow: 
                0 0 8px var(--shine-color), /* Resplandor principal */
                0 0 20px rgba(0,0,0,0.8);
        }
        .movie-meta { display: flex; flex-wrap: wrap; gap: 15px; color: var(--on-surface-variant-color); font-size: 0.95rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .movie-meta span { display: inline-flex; align-items: center; gap: 6px; }
        .movie-meta .material-icons { font-size: 1em; }
        
        .main-content { background-color: var(--background-color); padding: 20px; }
        .main-content h2 { font-size: 1.2rem; font-weight: 700; margin-top: 0; margin-bottom: 8px; }
        #movie-synopsis { color: var(--on-surface-variant-color); margin: 0; font-size: 1rem; }
        
        /* Estilos para el efecto 'Ver Más' */
        #movie-synopsis.collapsed { 
            display: -webkit-box; 
            -webkit-line-clamp: 3; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
        }
        .toggle-synopsis-btn { 
            background: none; border: none; 
            color: var(--main-red); font-family: 'Manrope', sans-serif; 
            font-weight: 700; cursor: pointer; padding: 4px 0; 
            margin-top: 4px; transition: color 0.2s; font-size: 0.9rem;
        }
        .toggle-synopsis-btn:hover { color: var(--shine-color); }
        
        .top-action-button { 
            position: absolute; top: 16px; color: #fff; background: rgba(26, 26, 26, 0.6); 
            border-radius: 50%; width: 44px; height: 44px; display: inline-flex; 
            align-items: center; justify-content: center; cursor: pointer; 
            border: 1px solid var(--border-color); text-decoration: none; 
            transition: all 0.2s; backdrop-filter: blur(5px);
        }
        .top-action-button:hover { transform: scale(1.1); background: rgba(26, 26, 26, 0.8); }
        .back-button { left: 16px; }
        #favorite-btn { right: 16px; }
        #favorite-btn.is-favorite { color: var(--main-red); text-shadow: 0 0 8px var(--shine-color); } /* Glow en favorito */

        /* FAB CON RESPLANDOR NEÓN Y ANIMACIÓN MEJORADA */
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 0 10px var(--main-red), 0 0 20px var(--shine-color); }
            50% { transform: scale(1.08); box-shadow: 0 0 15px var(--main-red), 0 0 30px var(--shine-color); }
            100% { transform: scale(1); box-shadow: 0 0 10px var(--main-red), 0 0 20px var(--shine-color); }
        }
        .fab { 
            position: fixed; bottom: 24px; right: 24px; width: 64px; height: 64px; 
            background-color: var(--main-red); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: var(--on-surface-color); /* Icono blanco sobre rojo */
            cursor: pointer; z-index: 998;
            animation: pulse-animation 2.5s infinite ease-in-out;
            border: 3px solid var(--on-surface-color);
        }
        .fab .material-icons { font-size: 2.5rem; }

        #episode-selector-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color); z-index: 1002;
            display: flex; flex-direction: column; transform: translateX(100%);
            transition: transform 0.35s cubic-bezier(0.3, 0.7, 0.4, 0.9);
        }
        #episode-selector-view.active { transform: translateX(0); }
        .selector-header {
            display: flex; align-items: center; padding: 12px;
            gap: 12px; background-color: var(--surface-color); flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
        }
        .selector-back-button { background: none; border: none; color: white; padding: 8px; cursor: pointer; display: flex; transition: color 0.2s; }
        .selector-back-button:hover { color: var(--main-red); }
        .selector-title { font-size: 1.25rem; font-weight: 700; margin: 0; }
        .season-tabs {
            display: flex; overflow-x: auto; background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            padding: 0 8px; -ms-overflow-style: none; scrollbar-width: none;
        }
        .season-tabs::-webkit-scrollbar { display: none; }
        .season-tab {
            padding: 14px 16px; cursor: pointer; color: var(--on-surface-variant-color);
            font-weight: 600; font-size: 0.95rem; white-space: nowrap;
            border-bottom: 3px solid transparent; transition: all 0.2s ease;
        }
        /* Pestaña activa con GLOW */
        .season-tab.active { 
            color: var(--main-red); 
            border-bottom-color: var(--main-red); 
            text-shadow: 0 0 5px var(--shine-color);
        }
        .season-tab:hover { color: var(--on-surface-color); }
        
        .episode-list { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex-grow: 1; }
        .episode-item {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .episode-item:hover {
            background-color: var(--main-accent-hover); 
            border-left: 4px solid var(--main-red); /* Borde de acento al hacer hover */
        }
        .episode-play-link { flex-grow: 1; padding: 16px; cursor: pointer; font-weight: 600; }
        .episode-cast-button {
            background: none; border: none; color: var(--on-surface-variant-color);
            cursor: pointer; padding: 16px;
            transition: color 0.2s; display: inline-flex; align-items: center;
        }
        .episode-cast-button:hover { color: var(--main-red); }

        /* ESTILOS PARA EPISODIOS VISTOS */
        .episode-item.is-watched {
            background-color: var(--main-accent-hover);
        }
        .episode-item.is-watched .episode-play-link {
            color: var(--on-surface-variant-color); 
            font-weight: 500;
        }
        .episode-item.is-watched .episode-play-link::after {
            content: ' ✓'; 
            color: var(--watched-color); 
            font-weight: 700;
        }
        
        #toast-container { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background-color: #323232; color: #fff; padding: 12px 20px; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; font-size: 0.9rem; }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        @media screen and (max-width: 600px) {
            .movie-banner { flex-direction: column; align-items: center; gap: 15px; padding: 15px; text-align: center; padding-top: 80px; min-height: 0; }
            .movie-poster { width: 150px; }
            .movie-info h1 { font-size: 1.8rem; }
            .fab { bottom: 16px; right: 16px; width: 56px; height: 56px; }
            .fab .material-icons { font-size: 2rem; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="series-detail-view">
    <div id="movie-banner" class="movie-banner">
        <a href="index.html" class="top-action-button back-button" title="Volver"><i class="material-icons">arrow_back</i></a>
        <button id="favorite-btn" class="top-action-button" title="Añadir a favoritos"><i class="material-icons">favorite_border</i></button>
        <div class="movie-poster"><img id="poster-img" src="" alt="Poster de la serie"></div>
        <div class="movie-info">
            <h1 id="movie-title"></h1>
            <div class="movie-meta"></div>
        </div>
    </div>
    <div class="main-content">
        <h2>SINOPSIS</h2>
        <div class="synopsis-container"><p id="movie-synopsis"></p></div> 
    </div>
    <div id="fab-play" class="fab">
        <i class="material-icons">playlist_play</i>
    </div>
</div>

<div id="episode-selector-view">
    <header class="selector-header">
        <button id="selector-back-button" class="selector-back-button" aria-label="Volver"><i class="material-icons">arrow_back</i></button>
        <h1 id="selector-title" class="selector-title"></h1>
    </header>
    <nav id="season-tabs" class="season-tabs"></nav>
    <ul id="episode-list" class="episode-list"></ul>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    // --- 1. CONFIGURACIÓN E INICIALIZACIÓN DE FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAvX9ZWG402NpI1UFyBxL_HxeMHSLF8fBI",
        authDomain: "hidraflix-ba716.firebaseapp.com",
        projectId: "hidraflix-ba716", 
    };

    let dbFirestore;
    try {
        firebase.initializeApp(firebaseConfig);
        dbFirestore = firebase.firestore();
    } catch (error) {
        console.error("Error al inicializar Firebase:", error);
    }
    // ----------------------------------------------------

    document.addEventListener('DOMContentLoaded', async () => {
        const contentId = new URLSearchParams(window.location.search).get('id');
        if (!contentId) { document.body.innerHTML = '<h1>Error: ID de serie no especificado.</h1>'; return; }
        if (!dbFirestore) { document.body.innerHTML = '<h1>Error: Firebase no está disponible.</h1>'; return; }
        
        try {
            const seriesDoc = await dbFirestore.collection('contenidos').doc(contentId).get();
            const seriesItem = seriesDoc.exists ? { id: seriesDoc.id, ...seriesDoc.data() } : null;

            if (!seriesItem || seriesItem.type !== 'series') {
                document.body.innerHTML = '<h1>Error: Serie no encontrada o tipo incorrecto.</h1>';
                return;
            }
            
            window.currentSeriesData = seriesItem;
            populateDetailPage(seriesItem);
            setupEventListeners(contentId);
            updateFavoriteButton(contentId);

        } catch (error) {
            console.error("Error al cargar datos desde Firebase:", error);
            document.body.innerHTML = '<h1>Error al cargar la aplicación.</h1>';
        }
    });

    function populateDetailPage(series) {
        document.title = series.title;
        document.getElementById('movie-title').textContent = series.title;
        document.getElementById('movie-banner').style.backgroundImage = `url('${series.banner || series.poster}')`;
        document.getElementById('poster-img').src = series.poster;
        
        // **ACTUALIZADO: Agregando la sinopsis y llamando al toggle**
        document.getElementById('movie-synopsis').textContent = series.synopsis || 'Sin sinopsis disponible.';
        setupSynopsisToggle();

        const metaContainer = document.querySelector('.movie-info .movie-meta');
        metaContainer.innerHTML = '';
        if (series.year) metaContainer.innerHTML += `<span><i class="material-icons">calendar_today</i>${series.year}</span>`;
        if (series.rating) metaContainer.innerHTML += `<span><i class="material-icons">star_border</i>${series.rating}</span>`;
        if (series.category) metaContainer.innerHTML += `<span><i class="material-icons">theater_comedy</i>${series.category}</span>`;
    }

    // --- NUEVA FUNCIÓN PARA EL EFECTO 'VER MÁS' ---
    function setupSynopsisToggle() {
        const synopsisP = document.getElementById('movie-synopsis');
        const container = synopsisP.parentElement;
        if (!synopsisP || !container) return;

        // Utilizamos la longitud del texto como proxy para saber si necesitamos el botón 'Ver más'
        if (synopsisP.textContent.length > 250) { 
            synopsisP.classList.add('collapsed');
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'toggle-synopsis-btn';
            toggleBtn.textContent = 'Ver más';
            container.appendChild(toggleBtn);
            toggleBtn.addEventListener('click', () => {
                const isCollapsed = synopsisP.classList.toggle('collapsed');
                toggleBtn.textContent = isCollapsed ? 'Ver más' : 'Ver menos';
            });
        }
    }
    // ---------------------------------------------


    function populateEpisodeSelector(series) {
        document.getElementById('selector-title').textContent = `${series.title} (${series.year})`;
        
        const seasonTabsContainer = document.getElementById('season-tabs');
        seasonTabsContainer.innerHTML = '';

        if (series.seasons && series.seasons.length > 0) {
            series.seasons.forEach((season, index) => {
                const tab = document.createElement('div');
                tab.className = 'season-tab';
                tab.textContent = `TEMPORADA ${season.season_number}`;
                tab.dataset.season = season.season_number;
                if (index === 0) tab.classList.add('active');
                seasonTabsContainer.appendChild(tab);
            });
            renderEpisodesForSeason(series.seasons[0].season_number);
        } else {
             document.getElementById('episode-list').innerHTML = `<li style="padding: 20px; text-align: center; color: var(--on-surface-variant-color);">No hay episodios disponibles.</li>`;
        }
    }

    // --- LÓGICA DE ESTADO 'VISTO' ---
    function getWatchedEpisodes(seriesId) { 
        const watched = JSON.parse(localStorage.getItem('cineflixter-watched') || '{}');
        return watched[seriesId] || [];
    }

    function saveWatchedEpisodes(seriesId, watchedList) { 
        const watched = JSON.parse(localStorage.getItem('cineflixter-watched') || '{}');
        watched[seriesId] = watchedList;
        localStorage.setItem('cineflixter-watched', JSON.stringify(watched));
    }

    function markEpisodeAsWatched(seriesId, seasonNumber, episodeNumber) {
        const episodeId = `S${seasonNumber}E${episodeNumber}`;
        let watchedList = getWatchedEpisodes(seriesId);
        
        if (!watchedList.includes(episodeId)) {
            watchedList.push(episodeId);
            saveWatchedEpisodes(seriesId, watchedList);
        }
    }

    function isEpisodeWatched(seriesId, seasonNumber, episodeNumber) {
        const episodeId = `S${seasonNumber}E${episodeNumber}`;
        return getWatchedEpisodes(seriesId).includes(episodeId);
    }
    // ---------------------------------------------

    function renderEpisodesForSeason(seasonNumber) {
        const episodeList = document.getElementById('episode-list');
        episodeList.innerHTML = '';
        const seasonData = window.currentSeriesData.seasons.find(s => s.season_number == seasonNumber);
        const seriesId = new URLSearchParams(window.location.search).get('id');

        if (seasonData && seasonData.episodes) {
            seasonData.episodes.forEach(episode => {
                const li = document.createElement('li');
                li.className = 'episode-item';
                
                li.dataset.season = seasonNumber;
                li.dataset.episode = episode.episode_number;

                if (seriesId && isEpisodeWatched(seriesId, seasonNumber, episode.episode_number)) {
                    li.classList.add('is-watched');
                }
                
                const episodeName = episode.title ? `: ${episode.title}` : '';
                li.innerHTML = `
                    <div class="episode-play-link" data-src="${episode.src}">
                        Episodio ${episode.episode_number}${episodeName}
                    </div>
                    <button class="episode-cast-button" data-cast-src="${episode.src}" title="Transmitir">
                        <i class="material-icons">cast</i>
                    </button>
                `;
                episodeList.appendChild(li);
            });
        }
    }

    function setupEventListeners(contentId) {
        const selectorView = document.getElementById('episode-selector-view');

        document.getElementById('fab-play').addEventListener('click', () => {
            populateEpisodeSelector(window.currentSeriesData);
            selectorView.classList.add('active');
        });

        document.getElementById('selector-back-button').addEventListener('click', () => {
            selectorView.classList.remove('active');
        });

        document.getElementById('season-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.season-tab')) {
                document.querySelector('.season-tab.active')?.classList.remove('active');
                e.target.classList.add('active');
                renderEpisodesForSeason(e.target.dataset.season);
            }
        });
        
        document.getElementById('episode-list').addEventListener('click', (e) => {
            const castButton = e.target.closest('.episode-cast-button');
            const playLink = e.target.closest('.episode-play-link');

            if (castButton) {
                const src = castButton.dataset.castSrc;
                if (src) window.location.href = `wvc-x-callback://open?url=${encodeURIComponent(src)}`;
            } else if (playLink) {
                const src = playLink.dataset.src;
                
                if (src) {
                    const seriesId = contentId;
                    const li = playLink.closest('.episode-item');
                    const seasonNumber = li?.dataset.season;
                    const episodeNumber = li?.dataset.episode;
                    
                    if (seriesId && seasonNumber && episodeNumber) {
                        markEpisodeAsWatched(seriesId, seasonNumber, episodeNumber);
                    }
                    
                    window.location.href = src;
                }
            }
        });

        document.getElementById('favorite-btn').addEventListener('click', () => toggleFavorite(contentId));
    }
    
    function showToast(message) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    function getFavorites() { return JSON.parse(localStorage.getItem('cineflixter-favorites') || '[]'); }
    function saveFavorites(arr) { localStorage.setItem('cineflixter-favorites', JSON.stringify(arr)); }

    function toggleFavorite(id) {
        let favs = getFavorites();
        const isFav = favs.includes(id);
        favs = isFav ? favs.filter(i => i !== id) : [...favs, id];
        saveFavorites(favs);
        updateFavoriteButton(id);
        showToast(isFav ? 'Eliminado de favoritos' : 'Añadido a favoritos');
    }

    function updateFavoriteButton(id) {
        const isFav = getFavorites().includes(id);
        const btn = document.getElementById('favorite-btn');
        if (!btn) return;
        const icon = btn.querySelector('.material-icons');
        btn.classList.toggle('is-favorite', isFav);
        icon.textContent = isFav ? 'favorite' : 'favorite_border';
    }
</script>
</body>
</html>