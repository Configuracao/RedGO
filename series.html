<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <title>Cargando...</title>
    
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('reloaded') !== 'true') {
                urlParams.set('reloaded', 'true');
                window.location.search = urlParams.toString();
            }
        })();
    </script>

    <style>
        :root {
            /* CAMBIO: Se confirma el rojo como color principal */
            --main-red: #E50914;
            --background-color: #121212;
            --surface-color: #1f1f1f;
            --on-surface-color: #FFFFFF;
            --on-surface-variant-color: #BDBDBD;
            --border-color: #2d2d2d;
        }

        body, html {
            margin: 0; padding: 0; font-family: 'Manrope', sans-serif;
            background-color: var(--background-color); color: var(--on-surface-color);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        a { text-decoration: none; color: inherit; }

        .movie-banner {
            position: relative; min-height: 350px; display: flex; align-items: flex-end;
            gap: 20px; padding: 20px; background-size: cover; background-position: center 20%;
        }
        .movie-banner::after {
            content: ''; position: absolute; bottom: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to top, var(--background-color) 10%, rgba(18, 18, 18, 0.5) 50%, transparent 100%);
            z-index: 1;
        }
        .movie-poster, .movie-info, .top-action-button { position: relative; z-index: 2; }
        .movie-poster { flex-shrink: 0; width: 180px; }
        .movie-poster img { width: 100%; border-radius: 8px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); display: block; }
        .movie-info h1 { font-size: 2.2rem; font-weight: 700; margin: 0 0 10px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .movie-meta { display: flex; flex-wrap: wrap; gap: 15px; color: var(--on-surface-variant-color); font-size: 0.95rem; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .movie-meta span { display: inline-flex; align-items: center; gap: 6px; }
        .movie-meta .material-icons { font-size: 1em; }
        
        .main-content { background-color: var(--background-color); padding: 20px; }
        .main-content h2 { font-size: 1.2rem; font-weight: 700; margin-top: 0; margin-bottom: 8px; }
        #movie-synopsis { color: var(--on-surface-variant-color); margin: 0; font-size: 1rem; }
        
        .top-action-button { position: absolute; top: 16px; color: #fff; background: transparent; border-radius: 50%; width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; border: none; text-decoration: none; transition: transform 0.2s, color 0.2s; }
        .back-button { left: 16px; }
        #favorite-btn { right: 16px; }
        #favorite-btn.is-favorite { color: var(--main-red); }

        /* CAMBIO: Se añade la animación de pulso al botón de episodios */
        @keyframes pulse-animation {
            0% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
            50% { transform: scale(1.08); box-shadow: 0 8px 20px rgba(0,0,0,0.6); }
            100% { transform: scale(1); box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        }
        .fab { 
            position: fixed; bottom: 24px; right: 24px; width: 56px; height: 56px; 
            background-color: var(--main-red); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.4); 
            cursor: pointer; z-index: 998;
            animation: pulse-animation 2s infinite ease-in-out;
        }

        #episode-selector-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color); z-index: 1002;
            display: flex; flex-direction: column; transform: translateX(100%);
            transition: transform 0.35s ease-out;
        }
        #episode-selector-view.active { transform: translateX(0); }
        .selector-header {
            display: flex; align-items: center; padding: 12px;
            gap: 12px; background-color: #181818; flex-shrink: 0;
        }
        .selector-back-button { background: none; border: none; color: white; padding: 8px; cursor: pointer; display: flex; }
        .selector-title { font-size: 1.25rem; font-weight: 600; margin: 0; }
        .season-tabs {
            display: flex; overflow-x: auto; background-color: #181818;
            border-bottom: 1px solid var(--border-color); flex-shrink: 0;
            padding: 0 8px; -ms-overflow-style: none; scrollbar-width: none;
        }
        .season-tabs::-webkit-scrollbar { display: none; }
        .season-tab {
            padding: 14px 16px; cursor: pointer; color: var(--on-surface-variant-color);
            font-weight: 600; font-size: 0.9rem; white-space: nowrap;
            border-bottom: 3px solid transparent; transition: color 0.2s ease, border-color 0.2s ease;
        }
        .season-tab.active { color: var(--on-surface-color); border-bottom-color: var(--main-red); }
        .episode-list { list-style: none; margin: 0; padding: 0; overflow-y: auto; flex-grow: 1; }
        .episode-item {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .episode-play-link { flex-grow: 1; padding: 16px; cursor: pointer; font-weight: 600; }
        .episode-cast-button {
            background: none; border: none; color: var(--on-surface-variant-color);
            cursor: pointer; padding: 16px;
            transition: color 0.2s; display: inline-flex; align-items: center;
        }
        
        #playback-modal {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.95); background-color: #2c2c2e;
            border-radius: 12px; z-index: 1005;
            box-shadow: 0 12px 17px 2px rgba(0,0,0,0.14), 0 5px 22px 4px rgba(0,0,0,0.12), 0 7px 8px -4px rgba(0,0,0,0.2);
            opacity: 0; visibility: hidden; transition: transform 0.3s ease, opacity 0.3s ease;
            display: flex; flex-direction: column; align-items: center; padding: 24px;
        }
        #playback-modal.is-active { transform: translate(-50%, -50%) scale(1); opacity: 1; visibility: visible; }
        body.player-active { overflow: hidden; }

        .spinner {
            height: 48px; width: 48px; animation: rotate 2s linear infinite;
            transform-origin: center center;
        }
        .spinner-path {
            stroke-dasharray: 1, 200; stroke-dashoffset: 0; stroke: var(--main-red);
            stroke-linecap: round; animation: dash 1.5s ease-in-out infinite;
        }
        @keyframes rotate { 100% { transform: rotate(360deg); } }
        @keyframes dash {
            0% { stroke-dasharray: 1, 200; stroke-dashoffset: 0; }
            50% { stroke-dasharray: 89, 200; stroke-dashoffset: -35px; }
            100% { stroke-dasharray: 89, 200; stroke-dashoffset: -124px; }
        }

        #toast-container { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%); z-index: 2000; }
        .toast { background-color: #323232; color: #fff; padding: 12px 20px; border-radius: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); opacity: 0; transform: translateY(20px); transition: opacity 0.3s ease, transform 0.3s ease; font-size: 0.9rem; }
        .toast.show { opacity: 1; transform: translateY(0); }
        
        @media screen and (max-width: 600px) {
            .movie-banner { flex-direction: column; align-items: center; gap: 15px; padding: 15px; text-align: center; padding-top: 80px; min-height: 0; }
            .movie-poster { width: 150px; }
            .movie-info h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

<div id="toast-container"></div>

<div id="series-detail-view">
    <div id="movie-banner" class="movie-banner">
        <a href="index.html" class="top-action-button back-button" title="Volver"><i class="material-icons">arrow_back</i></a>
        <button id="favorite-btn" class="top-action-button" title="Añadir a favoritos"><i class="material-icons">favorite_border</i></button>
        <div class="movie-poster"><img id="poster-img" src="" alt="Poster de la serie"></div>
        <div class="movie-info">
            <h1 id="movie-title"></h1>
            <div class="movie-meta"></div>
        </div>
    </div>
    <div class="main-content">
        <h2>SINOPSIS</h2>
        <p id="movie-synopsis"></p>
    </div>
    <div id="fab-play" class="fab">
        <i class="material-icons">playlist_play</i>
    </div>
</div>

<div id="episode-selector-view">
    <header class="selector-header">
        <button id="selector-back-button" class="selector-back-button" aria-label="Volver"><i class="material-icons">arrow_back</i></button>
        <h1 id="selector-title" class="selector-title"></h1>
    </header>
    <nav id="season-tabs" class="season-tabs"></nav>
    <ul id="episode-list" class="episode-list"></ul>
</div>

<div id="playback-modal">
    <svg class="spinner" viewBox="25 25 50 50">
        <circle class="spinner-path" cx="50" cy="50" r="20" fill="none" stroke-width="4" stroke-miterlimit="10"/>
    </svg>
</div>

<script>
    const playbackModal = document.getElementById('playback-modal');
    let playbackTimeout;
    let currentIframe = null;

    function showPlaybackModal() {
        playbackModal.classList.add('is-active');
        document.body.classList.add('player-active');
        if(history.state?.playbackModal !== true) {
            history.pushState({ playbackModal: true }, '');
        }
    }

    function hidePlaybackModal() {
        playbackModal.classList.remove('is-active');
        document.body.classList.remove('player-active');
        if (playbackTimeout) clearTimeout(playbackTimeout);
        if (currentIframe) {
            currentIframe.src = 'about:blank';
            currentIframe.remove();
            currentIframe = null;
        }
    }

    function startPlayback(videoUrl) {
        if (!videoUrl) { console.error("URL de video no válida."); return; }
        showPlaybackModal();
        currentIframe = document.createElement('iframe');
        currentIframe.src = videoUrl;
        currentIframe.style.cssText = "position:fixed;top:0;left:0;width:100%;height:100%;border:none;z-index:99999;display:none;";
        currentIframe.setAttribute('allow', 'autoplay; fullscreen');
        currentIframe.setAttribute('allowfullscreen', '');
        document.body.appendChild(currentIframe);
        
        playbackTimeout = setTimeout(() => {
            hidePlaybackModal();
            if(currentIframe) currentIframe.style.display = 'block';
        }, 5000);
    }

    window.addEventListener('popstate', (event) => {
        if (playbackModal.classList.contains('is-active') || currentIframe) {
             hidePlaybackModal();
        }
    });

    document.addEventListener('DOMContentLoaded', async () => {
        const contentId = new URLSearchParams(window.location.search).get('id');
        if (!contentId) {
            document.body.innerHTML = '<h1>Error: ID de serie no especificado.</h1>';
            return;
        }
        
        try {
            const res = await fetch('db.json?v=' + Date.now());
            const data = await res.json();
            const seriesItem = data.contenidos.find(c => c.id === contentId && c.type === 'series');
            if (!seriesItem) {
                document.body.innerHTML = '<h1>Error: Serie no encontrada.</h1>';
                return;
            }
            
            window.currentSeriesData = seriesItem;
            populateDetailPage(seriesItem);
            setupEventListeners(contentId);
            updateFavoriteButton(contentId);

        } catch (error) {
            console.error("Error al cargar datos:", error);
            document.body.innerHTML = '<h1>Error al cargar la aplicación.</h1>';
        }
    });

    function populateDetailPage(series) {
        document.title = series.title;
        document.getElementById('movie-title').textContent = series.title;
        document.getElementById('movie-banner').style.backgroundImage = `url('${series.banner || series.poster}')`;
        document.getElementById('poster-img').src = series.poster;
        document.getElementById('movie-synopsis').textContent = series.synopsis;

        const metaContainer = document.querySelector('.movie-info .movie-meta');
        metaContainer.innerHTML = '';
        if (series.year) metaContainer.innerHTML += `<span><i class="material-icons">calendar_today</i>${series.year}</span>`;
        if (series.rating) metaContainer.innerHTML += `<span><i class="material-icons">star_border</i>${series.rating}</span>`;
        if (series.category) metaContainer.innerHTML += `<span><i class="material-icons">theater_comedy</i>${series.category}</span>`;
    }

    function populateEpisodeSelector(series) {
        document.getElementById('selector-title').textContent = `${series.title} (${series.year})`;
        
        const seasonTabsContainer = document.getElementById('season-tabs');
        seasonTabsContainer.innerHTML = '';

        if (series.seasons && series.seasons.length > 0) {
            series.seasons.forEach((season, index) => {
                const tab = document.createElement('div');
                tab.className = 'season-tab';
                tab.textContent = `TEMPORADA ${season.season_number}`;
                tab.dataset.season = season.season_number;
                if (index === 0) tab.classList.add('active');
                seasonTabsContainer.appendChild(tab);
            });
            renderEpisodesForSeason(series.seasons[0].season_number);
        } else {
             document.getElementById('episode-list').innerHTML = `<li style="padding: 20px; text-align: center; color: var(--on-surface-variant-color);">No hay episodios disponibles.</li>`;
        }
    }

    function renderEpisodesForSeason(seasonNumber) {
        const episodeList = document.getElementById('episode-list');
        episodeList.innerHTML = '';
        const seasonData = window.currentSeriesData.seasons.find(s => s.season_number == seasonNumber);

        if (seasonData && seasonData.episodes) {
            seasonData.episodes.forEach(episode => {
                const li = document.createElement('li');
                li.className = 'episode-item';
                
                const episodeName = episode.title ? `: ${episode.title}` : '';
                li.innerHTML = `
                    <div class="episode-play-link" data-src="${episode.src}">
                        Episodio ${episode.episode_number}${episodeName}
                    </div>
                    <button class="episode-cast-button" data-cast-src="${episode.src}" title="Transmitir">
                        <i class="material-icons">cast</i>
                    </button>
                `;
                episodeList.appendChild(li);
            });
        }
    }

    function setupEventListeners(contentId) {
        const selectorView = document.getElementById('episode-selector-view');

        document.getElementById('fab-play').addEventListener('click', () => {
            populateEpisodeSelector(window.currentSeriesData);
            selectorView.classList.add('active');
        });

        document.getElementById('selector-back-button').addEventListener('click', () => {
            selectorView.classList.remove('active');
        });

        document.getElementById('season-tabs').addEventListener('click', (e) => {
            if (e.target.matches('.season-tab')) {
                document.querySelector('.season-tab.active')?.classList.remove('active');
                e.target.classList.add('active');
                renderEpisodesForSeason(e.target.dataset.season);
            }
        });
        
        document.getElementById('episode-list').addEventListener('click', (e) => {
            const castButton = e.target.closest('.episode-cast-button');
            const playLink = e.target.closest('.episode-play-link');

            if (castButton) {
                const src = castButton.dataset.castSrc;
                if (src) window.location.href = `wvc-x-callback://open?url=${encodeURIComponent(src)}`;
            } else if (playLink) {
                const src = playLink.dataset.src;
                if (src) startPlayback(src);
            }
        });

        document.getElementById('favorite-btn').addEventListener('click', () => toggleFavorite(contentId));
    }
    
    function showToast(message) {
        const container = document.getElementById('toast-container');
        if (!container) return;
        const toast = document.createElement('div');
        toast.className = 'toast';
        toast.textContent = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 3000);
    }
    
    // CAMBIO: Se usa 'cinemax-favorites' para guardar los favoritos
    function getFavorites() { return JSON.parse(localStorage.getItem('cinemax-favorites') || '[]'); }
    function saveFavorites(arr) { localStorage.setItem('cinemax-favorites', JSON.stringify(arr)); }

    function toggleFavorite(id) {
        let favs = getFavorites();
        const isFav = favs.includes(id);
        favs = isFav ? favs.filter(i => i !== id) : [...favs, id];
        saveFavorites(favs);
        updateFavoriteButton(id);
        showToast(isFav ? 'Eliminado de favoritos' : 'Añadido a favoritos');
    }

    function updateFavoriteButton(id) {
        const isFav = getFavorites().includes(id);
        const btn = document.getElementById('favorite-btn');
        if (!btn) return;
        const icon = btn.querySelector('.material-icons');
        btn.classList.toggle('is-favorite', isFav);
        icon.textContent = isFav ? 'favorite' : 'favorite_border';
    }
</script>
</body>
</html>