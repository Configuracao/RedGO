<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración - HydraFlix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            /* --- PALETA DE COLORES CON #4cb050 --- */
            /* @tweakable primary brand color */
            --primary-color: #4cb050; /* Verde principal de tu app */
            /* @tweakable primary brand hover color */
            --primary-hover: #45a049; /* Un verde ligeramente más oscuro para hovers */
            /* @tweakable primary button gradient */
            --gradient-primary: linear-gradient(135deg, #66bb6a 0%, #4cb050 100%);
            
            /* @tweakable accent color for destructive actions */
            --accent-color: #ff6b6b; /* Mantenemos un rojo para acciones destacadas/destructivas */
            /* @tweakable accent button gradient */
            --gradient-accent: linear-gradient(135deg, #ff6b6b 0%, #ff4757 100%);

            /* @tweakable darkest background color */
            --dark-bg: #0a0a0a;
            /* @tweakable secondary background color for sections/modals */
            --dark-secondary: #1a1a1a;
            /* @tweakable tertiary background color for cards/buttons */
            --dark-tertiary: #2a2a2a;
            /* @tweakable input field background color */
            --input-bg: #1e1e1e;
            /* @tweakable border color for elements */
            --border-color: rgba(255, 255, 255, 0.08);
            /* @tweakable primary text color */
            --text-primary: #ffffff;
            /* @tweakable secondary text color for details/labels */
            --text-secondary: #a0a0a0;
            /* @tweakable muted text color */
            --text-muted: #666666;
            /* @tweakable light shadow effect */
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.3);
            /* @tweakable heavy shadow effect */
            --shadow-heavy: 0 10px 40px rgba(0, 0, 0, 0.6);

            /* @tweakable success notification color */
            --success-color: #4cb050;
            /* @tweakable error notification color */
            --error-color: #e53935;
            /* @tweakable info notification color */
            --info-color: #2196f3;
            /* @tweakable warning notification color */
            --warning-color: #ffa000;

            /* @tweakable default main container horizontal padding */
            --main-padding-x: 24px;
            /* @tweakable default modal content padding */
            --modal-padding: 32px;
            /* @tweakable default form group padding */
            --form-group-padding: 20px;
        }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(20px); } }
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        .spin { animation: spin 1s linear infinite; }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html, button, input, select, textarea { font-family: 'Inter', -apple-system, sans-serif; background-color: var(--dark-bg); color: var(--text-primary); line-height: 1.6; }
        body { overflow-x: hidden; background: radial-gradient(ellipse at top, rgba(76, 176, 80, 0.03) 0%, transparent 70%); min-height: 100vh; }
        
        /* NEW: Utility class for hiding elements */
        .hidden {
            display: none !important;
        }

        /* Header */
        .header { display: flex; align-items: center; justify-content: space-between; padding: 16px var(--main-padding-x); position: sticky; top: 0; z-index: 1000; background: rgba(26, 26, 26, 0.95); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); box-shadow: var(--shadow-light); }
        .app-title { position: absolute; left: 50%; transform: translateX(-50%); font-size: 22px; font-weight: 700; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; letter-spacing: -0.02em; }
        .menu-btn, .header-action-btn { background: none; border: none; color: var(--text-primary); cursor: pointer; padding: 12px; border-radius: 12px; display: flex; align-items: center; justify-content: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); width: 44px; height: 44px; }
        .menu-btn:hover, .header-action-btn:hover { background: var(--input-bg); transform: translateY(-2px); box-shadow: var(--shadow-light); }
        
        /* Side Menu */
        .side-menu { position: fixed; top: 0; left: -320px; width: 320px; height: 100vh; background: var(--dark-secondary); transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1001; border-right: 1px solid var(--border-color); box-shadow: var(--shadow-heavy); }
        .side-menu.active { left: 0; }
        .side-menu-header { padding: 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: var(--dark-tertiary); }
        .side-menu-header h2 { font-size: 20px; font-weight: 600; }
        .side-menu-content { padding: 20px; }
        .side-menu-item { display: flex; align-items: center; padding: 16px 20px; color: var(--text-secondary); text-decoration: none; cursor: pointer; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 12px; margin-bottom: 8px; font-weight: 500; gap: 16px; }
        .side-menu-item:hover { color: var(--primary-color); background: rgba(76, 176, 80, 0.1); transform: translateX(8px); }
        .side-menu-item .material-icons { font-size: 20px; }
        .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px); display: none; z-index: 998; opacity: 0; transition: opacity 0.3s ease; }
        .overlay.active { display: block; opacity: 1; }

        /* Main Content */
        .main-container { padding: 32px var(--main-padding-x); max-width: 1400px; margin: 0 auto; animation: fadeIn 0.8s ease-out; }
        .main-container h1 { font-size: 32px; margin-bottom: 32px; font-weight: 700; }
        
        /* Stats & Controls */
        .content-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-item { background: var(--dark-secondary); padding: 24px; border-radius: 16px; border: 1px solid var(--border-color); display: flex; align-items: center; gap: 16px; transition: all 0.3s; position: relative; overflow: hidden; }
        .stat-item::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--gradient-primary); opacity: 0; transition: opacity 0.3s ease; }
        .stat-item:hover { transform: translateY(-4px); box-shadow: var(--shadow-light); }
        .stat-item:hover::before { opacity: 1; }
        .stat-item .material-icons { color: var(--primary-color); font-size: 28px; padding: 12px; background: rgba(76, 176, 80, 0.1); border-radius: 12px; }
        .stat-item span { font-size: 16px; color: var(--text-secondary); }
        .stat-item strong { color: var(--text-primary); font-size: 24px; font-weight: 700; display: block; }
        
        .controls { display: flex; gap: 20px; background: var(--dark-secondary); padding: 24px; border-radius: 16px; margin-bottom: 32px; border: 1px solid var(--border-color); align-items: center; justify-content: space-between; flex-wrap: wrap; }
        .search-container { flex: 1; min-width: 300px; position: relative; }
        #local-search-input { width: 100%; padding: 14px 50px 14px 20px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary); font-size: 16px; border-radius: 12px; transition: all 0.3s; }
        #local-search-input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(76, 176, 80, 0.2); }
        .search-icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); pointer-events: none; }
        
        /* Buttons */
        .btn { background: var(--gradient-primary); color: white; border: none; padding: 14px 24px; border-radius: 12px; cursor: pointer; font-size: 16px; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.3s; text-decoration: none; position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(76, 176, 80, 0.3); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: var(--input-bg); color: var(--text-muted); cursor: not-allowed; transform: none; box-shadow: none; }
        
        /* Content List */
        .content-list { list-style: none; padding: 0; background: var(--dark-secondary); border-radius: 16px; overflow: hidden; border: 1px solid var(--border-color); }
        .content-item { display: flex; align-items: center; padding: 20px; border-bottom: 1px solid var(--border-color); transition: all 0.3s; gap: 20px; }
        .content-item:hover { background: rgba(76, 176, 80, 0.05); transform: translateX(4px); }
        .content-item:last-child { border-bottom: none; }
        .content-item img { width: 50px; height: 75px; object-fit: cover; border-radius: 8px; flex-shrink: 0; background: var(--input-bg); box-shadow: var(--shadow-light); }
        .content-info { flex-grow: 1; }
        .content-info strong { display: block; font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .content-info span { font-size: 14px; color: var(--text-secondary); text-transform: capitalize; }
        .content-actions { display: flex; gap: 12px; flex-shrink: 0; }
        .content-actions .btn { background: var(--dark-tertiary); border: 1px solid var(--border-color); width: 44px; height: 44px; padding: 0; border-radius: 10px; }
        .content-actions .edit-btn:hover { background: rgba(76, 176, 80, 0.2); border-color: var(--primary-color); color: var(--primary-color); }
        .content-actions .delete-btn:hover { background: rgba(255, 71, 87, 0.2); border-color: var(--error-color); color: var(--error-color); }
        
        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); animation: fadeIn 0.3s ease; }
        .modal-content { background: var(--dark-secondary); margin: 2% auto; padding: var(--modal-padding); border-radius: 20px; width: 90%; max-width: 900px; border: 1px solid var(--border-color); box-shadow: var(--shadow-heavy); max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; margin-bottom: 24px; }
        .modal-header h2 { font-size: 24px; font-weight: 700; }
        .close-modal-btn { color: var(--text-muted); font-size: 28px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-modal-btn:hover { color: var(--text-primary); background: var(--input-bg); }
        
        /* Form Styles */
        .form-group { background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: var(--form-group-padding); margin-bottom: 20px; transition: all 0.3s; }
        .form-group:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(76, 176, 80, 0.1); }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px; letter-spacing: 0.5px; }
        .form-group input, .form-group select, .form-group textarea { background: transparent; border: none; padding: 0; width: 100%; font-size: 16px; color: var(--text-primary); font-weight: 500; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; }
        .form-group select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234cb050' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0 center; }
        
        /* TMDB Section Styles */
        .tmdb-search-container { background: var(--dark-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .tmdb-search-container h3 { color: var(--primary-color); font-size: 14px; margin-bottom: 16px; text-transform: uppercase; font-weight: 600; }
        #tmdb-search-controls { display: flex; flex-direction: column; gap: 16px; }
        #tmdb-search-input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); }
        #tmdb-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 15px; margin-top: 20px; max-height: 350px; overflow-y: auto; padding: 8px; }
        .tmdb-result-item { cursor: pointer; text-align: center; transition: all 0.3s; font-size: 14px; border-radius: 12px; padding: 12px; border: 1px solid var(--border-color); background: var(--dark-tertiary); }
        .tmdb-result-item:hover { transform: translateY(-4px) scale(1.02); background: var(--input-bg); border-color: var(--primary-color); box-shadow: var(--shadow-light); }
        .tmdb-result-item img { width: 100%; border-radius: 8px; margin-bottom: 8px; box-shadow: var(--shadow-light); }
        .tmdb-result-item span { display: block; color: var(--text-secondary); }
        #tmdb-status { margin-top: 16px; padding: 12px 16px; border-radius: 8px; font-size: 14px; display: flex; align-items: center; gap: 10px; transition: all 0.3s; font-weight: 500; border: 1px solid transparent; }
        #tmdb-status .material-icons { font-size: 18px; }
        .status-loading { color: var(--text-secondary); background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1); }
        .status-success { color: var(--success-color); background: rgba(76, 176, 80, 0.1); border-color: rgba(76, 176, 80, 0.2); }
        .status-error { color: var(--error-color); background: rgba(229, 57, 53, 0.1); border-color: rgba(229, 57, 53, 0.2); }
        .status-info { color: var(--primary-color); background: rgba(76, 176, 80, 0.08); border-color: rgba(76, 176, 80, 0.15); }
        
        /* Dynamic Form Groups */
        .option-group, .episode-group { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .option-group input, .episode-group input { flex-grow: 1; padding: 12px 16px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); transition: all 0.3s ease; }
        .option-group input:focus, .episode-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(76, 176, 80, 0.1); }
        .remove-item-btn { background: var(--dark-tertiary); border: 1px solid var(--border-color); color: var(--text-muted); cursor: pointer; padding: 8px; display: flex; border-radius: 8px; transition: all 0.3s ease; }
        .remove-item-btn:hover { color: var(--error-color); background: rgba(229, 57, 53, 0.1); border-color: var(--error-color); }
        .season-block { border: 1px solid var(--border-color); border-radius: 12px; padding: 20px; margin-bottom: 16px; background: var(--dark-tertiary); }
        .season-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .season-header h3 { font-size: 18px; font-weight: 600; }
        
        /* --- ESTILOS PARA NOTIFICACIONES Y CONFIRMACIÓN --- */
        #notification-container { position: fixed; top: 20px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 10px; }
        /* @tweakable notification animation duration */
        .notification { display: flex; align-items: center; padding: 16px; border-radius: 12px; color: white; background: var(--dark-tertiary); border: 1px solid var(--border-color); box-shadow: var(--shadow-heavy); min-width: 300px; transform: translateX(calc(100% + 20px)); animation: notification-slide-in 0.5s forwards, notification-slide-out 0.5s 4.5s forwards; }
        .notification .material-icons { margin-right: 12px; font-size: 22px; }
        .notification.success { background: #1e4620; border-left: 5px solid var(--success-color); }
        .notification.error { background: #4d1818; border-left: 5px solid var(--error-color); }
        .notification.info { background: #10385c; border-left: 5px solid var(--info-color); }
        @keyframes notification-slide-in { from { transform: translateX(calc(100% + 20px)); } to { transform: translateX(0); } }
        @keyframes notification-slide-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(calc(100% + 20px)); opacity: 0; } }

        #confirm-modal .modal-content { max-width: 500px; margin-top: 10%; text-align: center; }
        #confirm-modal p { font-size: 18px; color: var(--text-secondary); margin-bottom: 24px; }
        #confirm-modal-actions { display: flex; justify-content: center; gap: 16px; }
        #confirm-modal-actions .btn-confirm { background: var(--gradient-accent); }
        #confirm-modal-actions .btn-cancel { background: var(--dark-tertiary); }
        
        @media (max-width: 768px) {
            :root {
                /* @tweakable main container horizontal padding on tablets */
                --main-padding-x: 20px;
                /* @tweakable modal content padding on tablets */
                --modal-padding: 24px;
                /* @tweakable form group padding on tablets */
                --form-group-padding: 16px;
            }
            .main-container { padding: 25px var(--main-padding-x); } 
            .header { padding: 14px var(--main-padding-x); }
            .content-stats { grid-template-columns: 1fr; gap: 16px; } 
            .controls { flex-direction: column; align-items: stretch; gap: 16px; } 
            .search-container { min-width: unset; width: 100%; } 
            .modal-content { padding: var(--modal-padding); max-width: 95%; margin: 5% auto; } 
            .form-group { padding: var(--form-group-padding); } 
            .form-group label { margin-bottom: 8px; font-size: 11px; } 
            .form-group input, .form-group select, .form-group textarea { font-size: 15px; } 
            .btn { padding: 12px 20px; font-size: 15px; } 
            .modal-content { padding: var(--modal-padding); } 
            .modal-header h2 { font-size: 20px; }
            .form-group { padding: var(--form-group-padding); } 
            .form-group input, .form-group select, .form-group textarea { font-size: 14px; } 
            #tmdb-search-input { padding: 10px; font-size: 15px; }
            .tmdb-result-item { font-size: 13px; padding: 10px; border-radius: 10px; }
            .tmdb-result-item img { border-radius: 6px; }
            .content-item img { width: 40px; height: 60px; } 
            .content-info strong { font-size: 16px; } 
            .content-info span { font-size: 13px; } 
            .content-actions .btn { width: 40px; height: 40px; font-size: 18px; border-radius: 8px;} 
            .content-actions .btn .material-icons { font-size: 20px; } 
            .option-group input, .episode-group input { padding: 10px 14px; font-size: 14px; } 
            .remove-item-btn { padding: 6px; font-size: 18px; } 
            .season-block { padding: 16px; }
            .season-header h3 { font-size: 16px; }
            .side-menu { width: 280px; left: -280px; } 
            .side-menu.active { left: 0; }
        }

        @media (max-width: 480px) {
            :root {
                /* @tweakable main container horizontal padding on mobile phones */
                --main-padding-x: 16px;
                /* @tweakable modal content padding on mobile phones */
                --modal-padding: 20px;
                /* @tweakable form group padding on mobile phones */
                --form-group-padding: 14px;
            }
            .main-container { padding: 20px var(--main-padding-x); } 
            .header { padding: 12px var(--main-padding-x); }
            .app-title { font-size: 20px; }
            .menu-btn, .header-action-btn { width: 38px; height: 38px; padding: 10px; }
            .stat-item { padding: 20px; } 
            .stat-item .material-icons { font-size: 24px; padding: 10px; } 
            .stat-item strong { font-size: 20px; } 
            .stat-item span { font-size: 14px; } 
            .btn { padding: 12px 20px; font-size: 15px; } 
            .modal-content { padding: var(--modal-padding); } 
            .modal-header h2 { font-size: 20px; }
            .form-group { padding: var(--form-group-padding); } 
            .form-group input, .form-group select, .form-group textarea { font-size: 14px; } 
            #tmdb-search-input { padding: 10px; font-size: 14px; }
            .tmdb-result-item { font-size: 12px; padding: 8px; }
            .content-item { flex-wrap: wrap; text-align: center; justify-content: center; padding: 15px; } 
            .content-item img { width: 60px; height: 90px; margin-bottom: 10px; } 
            .content-info { flex-basis: 100%; text-align: center; } 
            .content-actions { width: 100%; justify-content: center; margin-top: 10px; } 
            .option-group, .episode-group { flex-wrap: wrap; } 
            .option-group input, .episode-group input { flex-basis: 100%; } 
            .remove-item-btn { margin-left: auto; margin-right: auto; } 
            .season-block { padding: 14px; }
            .side-menu { width: 250px; left: -250px; } 
            .side-menu.active { left: 0; }
        }
    </style>
</head>
<body>

<header class="header">
    <button class="menu-btn" aria-label="Abrir menú"><i class="material-icons">menu</i></button>
    <div class="app-title">HydraFlix Panel</div>
    <a href="logout.php" class="header-action-btn" title="Cerrar Sesión"><i class="material-icons">logout</i></a>
</header>

<div class="side-menu">
    <div class="side-menu-header">
        <h2>Menú</h2>
        <button class="menu-btn" aria-label="Cerrar menú"><i class="material-icons">close</i></button>
    </div>
    <div class="side-menu-content">
        <a href="#" id="add-new-menu-btn" class="side-menu-item"><i class="material-icons">add_circle_outline</i><span>Añadir Contenido</span></a>
        <a href="index.html" target="_blank" class="side-menu-item"><i class="material-icons">visibility</i><span>Ver Sitio</span></a>
    </div>
</div>
<div class="overlay"></div>

<main class="main-container">
    <h1>Gestionar Contenido</h1>
    <div class="content-stats">
        <div id="movies-stats-container" class="stat-item"></div>
        <div id="series-stats-container" class="stat-item"></div>
    </div>
    <div class="controls">
        <div class="search-container">
            <input type="text" id="local-search-input" placeholder="Buscar en mi contenido por título...">
            <i class="material-icons search-icon">search</i>
        </div>
        <button id="add-new-main-btn" class="btn"><i class="material-icons">add</i>Añadir Nuevo</button>
    </div>
    <ul id="content-list" class="content-list"></ul>
</main>

<!-- MODAL PRINCIPAL PARA FORMULARIO -->
<div id="form-modal" class="modal">
    <!-- Contenido del modal se genera con JS... -->
</div>

<!-- CONTENEDORES PARA NOTIFICACIONES Y CONFIRMACIÓN -->
<div id="notification-container"></div>
<div id="confirm-modal" class="modal">
    <div class="modal-content">
        <p id="confirm-modal-text">¿Estás seguro?</p>
        <div id="confirm-modal-actions">
            <button id="confirm-btn-yes" class="btn btn-confirm">Sí, eliminar</button>
            <button id="confirm-btn-no" class="btn btn-cancel">Cancelar</button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getDatabase, ref, set, onValue, remove } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js';

    // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
    const firebaseConfig = {
        apiKey: "AIzaSyAEbMY3zYyxIjTREF-0kO-eK7soHAyy084",
        authDomain: "web-de-peli.firebaseapp.com",
        databaseURL: "https://web-de-peli-default-rtdb.firebaseio.com",
        projectId: "web-de-peli",
        storageBucket: "web-de-peli.firebasestorage.app",
        messagingSenderId: "94710081234",
        appId: "1:94710081234:web:4a106a5e25bd50e6c56f0b"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y CONFIGURACIÓN ---
        let contentDataArray = []; // Renamed from 'database.contenidos' for clarity, now holds the array from Firebase
        /* @tweakable TMDB API Key for content search functionality */
        const TMDB_API_KEY = 'e416234abcb5d260538a8f7ce6ba12e4';

        // --- SELECTORES DEL DOM ---
        const contentList = document.getElementById('content-list');
        const moviesStatsContainer = document.getElementById('movies-stats-container');
        const seriesStatsContainer = document.getElementById('series-stats-container');
        const formModal = document.getElementById('form-modal');
        const localSearchInput = document.getElementById('local-search-input');
        const notificationContainer = document.getElementById('notification-container');
        const confirmModal = document.getElementById('confirm-modal');
        
        // --- UTILIDADES ---
        /* @tweakable debounce delay for search input in milliseconds */
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        function showNotification(message, type = 'info', /* @tweakable notification display duration in milliseconds */ duration = 5000) {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            const icons = { success: 'check_circle', error: 'error', info: 'info' };
            notif.innerHTML = `<i class="material-icons">${icons[type]}</i><span>${message}</span>`;
            notificationContainer.appendChild(notif);
            setTimeout(() => { notif.remove(); }, duration);
        }

        function showConfirmation(message) {
            return new Promise(resolve => {
                document.getElementById('confirm-modal-text').textContent = message;
                confirmModal.style.display = 'block';
                const yesBtn = document.getElementById('confirm-btn-yes');
                const noBtn = document.getElementById('confirm-btn-no');
                const cleanup = (result) => {
                    confirmModal.style.display = 'none';
                    resolve(result);
                };
                yesBtn.onclick = () => cleanup(true);
                noBtn.onclick = () => cleanup(false);
            });
        }

        // --- LÓGICA DE DATOS Firebase ---
        // Setup a real-time listener for content data
        function setupFirebaseListener() {
            const contentsRef = ref(database, 'contenidos');
            onValue(contentsRef, (snapshot) => {
                const data = snapshot.val();
                contentDataArray = data ? Object.values(data) : [];
                /* @tweakable sort order for admin content list (true = newest first, false = oldest first) */
                const sortNewestFirstInAdmin = true; 
                contentDataArray.sort((a, b) => {
                    const dateA = a.dateAdded ? new Date(a.dateAdded).getTime() : parseInt(a.id, 10);
                    const dateB = b.dateAdded ? new Date(b.dateAdded).getTime() : parseInt(b.id, 10);
                    return sortNewestFirstInAdmin ? (dateB - dateA) : (dateA - dateB);
                });
                renderList(); // Re-render the list whenever data changes in Firebase
            }, (error) => {
                console.error("Error al cargar el contenido desde Firebase:", error);
                showNotification('Error al cargar el contenido desde la base de datos.', 'error');
            });
        }

        // --- LÓGICA DE RENDERIZADO ---
        function updateStats() {
            const moviesCount = contentDataArray.filter(c => c.type === 'movie').length;
            const seriesCount = contentDataArray.filter(c => c.type === 'series').length;
            moviesStatsContainer.innerHTML = `<i class="material-icons">movie</i><div><strong>${moviesCount}</strong><span> Películas</span></div>`;
            seriesStatsContainer.innerHTML = `<i class="material-icons">tv</i><div><strong>${seriesCount}</strong><span> Series</span></div>`;
        }
        
        function renderList(contentToRender = contentDataArray) {
            updateStats();
            contentList.innerHTML = "";
            if (contentToRender.length === 0) {
                const message = localSearchInput.value ? 'No se encontraron coincidencias.' : 'Aún no hay contenido. ¡Añade algo!';
                contentList.innerHTML = `<li class="content-item" style="justify-content:center; color: var(--text-secondary);">${message}</li>`;
                return;
            }
            const fragment = document.createDocumentFragment();
            // SIN ORDENAR: MANTIENE EL ORDEN DE AÑADIDO
            contentToRender.forEach(item => {
                const li = document.createElement("li");
                li.className = "content-item";
                li.innerHTML = `
                    <img src="${item.poster || ''}" alt="Poster" loading="lazy" onerror="this.src='https://via.placeholder.com/50x75/1e1e1e/666?text=No+Img'">
                    <div class="content-info">
                        <strong>${item.title || 'Sin Título'}</strong>
                        <span>${item.type === 'movie' ? 'Película' : 'Serie'} | ${item.year || 'N/A'}</span>
                    </div>
                    <div class="content-actions">
                        <button class="btn edit-btn" data-id="${item.id}" title="Editar"><i class="material-icons">edit</i></button>
                        <button class="btn delete-btn" data-id="${item.id}" title="Eliminar"><i class="material-icons">delete</i></button>
                    </div>
                `;
                fragment.appendChild(li);
            });
            contentList.appendChild(fragment);
        }
        
        function openModal(item = null) {
            const modalHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="modal-title"></h2>
                        <span class="close-modal-btn">×</span>
                    </div>
                    <div class="tmdb-search-container">
                        <h3><i class="material-icons" style="font-size:16px; vertical-align: bottom; margin-right: 5px;">travel_explore</i>Buscar en TMDB para autocompletar</h3>
                        <div id="tmdb-search-controls">
                            <input type="text" id="tmdb-search-input" placeholder="Escribe un título...">
                        </div>
                        <div id="tmdb-results"></div>
                        <div id="tmdb-status" class="hidden"></div>
                    </div>
                    <form id="content-form">
                        <input type="hidden" id="content-id">
                        <input type="hidden" id="dateAdded"> <!-- NEW: Hidden input for dateAdded -->
                        <div class="form-group"><label for="type">Tipo</label><select id="type" required><option value="movie">Película</option><option value="series">Serie</option></select></div>
                        <div class="form-group"><label for="title">Título</label><input type="text" id="title" required></div>
                        <div class="form-group"><label for="poster">URL del Póster</label><input type="url" id="poster" required></div>
                        <div class="form-group"><label for="banner">URL del Banner</label><input type="url" id="banner"></div>
                        <div class="form-group"><label for="category">Género</label><select id="category" required><option value="accion">Acción</option><option value="aventura">Aventura</option><option value="animacion">Animación</option><option value="anime">Anime</option><option value="comedia">Comedia</option><option value="crimen">Crimen</option><option value="documental">Documental</option><option value="drama">Drama</option><option value="familia">Familia</option><option value="fantasia">Fantasía</option><option value="historia">Historia</option><option value="terror">Terror</option><option value="infantil">Infantil</option><option value="musica">Música</option><option value="misterio">Misterio</option><option value="romance">Romance</option><option value="ciencia-ficcion">Ciencia ficción</option><option value="suspenso">Suspenso</option><option value="belica">Bélica</option><option value="western">Western</option></select></div>
                        <div class="form-group"><label for="year">Año</label><input type="number" id="year" min="1900" max="2100"></div>
                        <div class="form-group"><label for="duration">Duración</label><input type="text" id="duration" placeholder="Ej: 1h 30m"></div>
                        <div class="form-group"><label for="rating">Calificación</label><input type="text" id="rating" placeholder="Ej: 7.8 / 10"></div>
                        <div class="form-group"><label for="synopsis">Sinopsis</label><textarea id="synopsis" rows="4"></textarea></div>
                        <div id="movie-options-container" class="form-group hidden"><h3>Opciones de Video (Película)</h3><div id="options-list"></div><button type="button" id="add-option-btn" class="btn" style="margin-top:10px;">Añadir Opción</button></div>
                        <div id="series-options-container" class="form-group hidden"><h3>Temporadas y Episodios</h3><div id="seasons-list"></div><button type="button" id="add-season-btn" class="btn" style="margin-top:10px;">Añadir Temporada</button></div>
                        <button type="submit" class="btn" style="width: 100%; padding: 15px; margin-top: 10px; font-size: 18px;"><i class="material-icons">check_circle</i>Guardar Contenido</button>
                    </form>
                </div>
            `;
            formModal.innerHTML = modalHTML;
            document.getElementById('modal-title').textContent = item ? 'Editar Contenido' : 'Añadir Nuevo Contenido';
            if (item) {
                document.getElementById('content-id').value = item.id;
                document.getElementById('dateAdded').value = item.dateAdded || ''; // Populate dateAdded if it exists
                Object.keys(item).forEach(key => {
                    const el = document.getElementById(key);
                    if (el && item[key] !== undefined) el.value = item[key];
                });
                if (item.type === "movie" && Array.isArray(item.options)) item.options.forEach(opt => addMovieOptionInput(opt.label, opt.src));
                if (item.type === "series" && Array.isArray(item.seasons)) item.seasons.forEach(season => {
                    const sBlock = addSeasonBlock(season.season_number);
                    if (Array.isArray(season.episodes)) season.episodes.forEach(ep => addEpisodeInput(sBlock.querySelector('.episodes-container'), ep.title, ep.src));
                });
            } else {
                // For new items, pre-fill dateAdded
                document.getElementById('dateAdded').value = new Date().toISOString();
            }
            setupModalEventListeners();
            // Ensure correct sections are shown/hidden based on the initial 'type' value
            toggleFormSections(); 
            formModal.style.display = 'block';
        }
        
        function closeModal() {
            formModal.style.display = 'none';
            formModal.innerHTML = '';
        }

        // --- MANEJADORES DE EVENTOS ---
        function setupGlobalEventListeners() {
            const sideMenu = document.querySelector('.side-menu');
            const overlay = document.querySelector('.overlay');
            document.querySelectorAll('.menu-btn').forEach(btn => btn.addEventListener('click', () => { sideMenu.classList.toggle('active'); overlay.classList.toggle('active'); }));
            overlay.addEventListener('click', () => { sideMenu.classList.remove('active'); overlay.classList.remove('active'); });
            document.getElementById('add-new-menu-btn').addEventListener('click', e => { e.preventDefault(); openModal(); sideMenu.classList.remove('active'); overlay.classList.remove('active'); });
            document.getElementById('add-new-main-btn').addEventListener('click', () => openModal());
            localSearchInput.addEventListener('input', debounce(e => {
                const searchTerm = e.target.value.toLowerCase().trim();
                const filteredContent = contentDataArray.filter(item => item.title.toLowerCase().includes(searchTerm));
                renderList(filteredContent);
            }, 300));
            contentList.addEventListener('click', async (e) => {
                const button = e.target.closest('button.btn');
                if (!button) return;
                const id = button.dataset.id;
                if (button.classList.contains('edit-btn')) {
                    const itemToEdit = contentDataArray.find(c => c.id === id);
                    if (itemToEdit) openModal(itemToEdit);
                } else if (button.classList.contains('delete-btn')) {
                    if (await showConfirmation('¿Estás seguro de que quieres eliminar este contenido? Esta acción no se puede deshacer.')) {
                        try {
                            await remove(ref(database, 'contenidos/' + id));
                            showNotification('Contenido eliminado.', 'info');
                        } catch (error) {
                            console.error("Error al eliminar contenido:", error);
                            showNotification('Error al eliminar el contenido.', 'error');
                        }
                    }
                }
            });
        }
        
        const genreMap = {'Acción': 'accion', 'Aventura': 'aventura', 'Animación': 'animacion', 'Comedia': 'comedia', 'Crimen': 'crimen', 'Documental': 'documental', 'Drama': 'drama', 'Familia': 'familia', 'Fantasía': 'fantasia', 'Historia': 'historia', 'Terror': 'terror', 'Infantil': 'infantil', 'Música': 'musica', 'Misterio': 'misterio', 'Romance': 'romance', 'Ciencia ficción': 'ciencia-ficcion', 'Suspenso': 'suspenso', 'Bélica': 'belica', 'Guerra': 'belica', 'Western': 'western', 'Action & Adventure': 'accion', 'Sci-Fi & Fantasy': 'ciencia-ficcion', 'Kids': 'infantil', 'Anime': 'anime' };
        function setupModalEventListeners() { document.getElementById('content-form').addEventListener('submit', handleFormSubmit); document.querySelector('.close-modal-btn').onclick = closeModal; window.onclick = e => { if (e.target == formModal) closeModal(); }; document.getElementById('type').addEventListener('change', toggleFormSections); document.getElementById('add-option-btn').addEventListener('click', () => addMovieOptionInput()); document.getElementById('add-season-btn').addEventListener('click', () => { const seasonNumbers = Array.from(document.querySelectorAll('.season-block')).map(b => parseInt(b.dataset.seasonNumber, 10)); const newSeasonNumber = seasonNumbers.length > 0 ? Math.max(...seasonNumbers) + 1 : 1; addSeasonBlock(newSeasonNumber); }); document.getElementById('tmdb-search-input').addEventListener('input', debounce(searchTmdb, 500)); }
        function toggleFormSections() { const type = document.getElementById('type').value; document.getElementById('movie-options-container').classList.toggle('hidden', type !== 'movie'); document.getElementById('series-options-container').classList.toggle('hidden', type !== 'series'); }
        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('content-id').value || String(Date.now()); // Generate ID if new
            const type = document.getElementById('type').value;
            const contentData = {
                id, // Use the generated/existing ID
                type,
                title: document.getElementById('title').value,
                poster: document.getElementById('poster').value,
                banner: document.getElementById('banner').value,
                category: document.getElementById('category').value,
                year: document.getElementById('year').value,
                duration: document.getElementById('duration').value,
                rating: document.getElementById('rating').value,
                synopsis: document.getElementById('synopsis').value,
                // NEW: Ensure dateAdded is stored for proper sorting on the main site
                dateAdded: document.getElementById('dateAdded').value || new Date().toISOString()
            };
            if (type === 'movie') {
                contentData.options = Array.from(document.querySelectorAll('#options-list .option-group')).map(g => ({ label: g.querySelector('input:nth-child(1)').value, src: g.querySelector('input:nth-child(2)').value }));
            } else {
                contentData.seasons = Array.from(document.querySelectorAll('#seasons-list .season-block')).map(s => ({ season_number: parseInt(s.dataset.seasonNumber, 10), episodes: Array.from(s.querySelectorAll('.episode-group')).map((ep, i) => ({ episode_number: i + 1, title: ep.querySelector('.episode-title').value, src: ep.querySelector('.episode-src').value })) }));
            }

            try {
                await set(ref(database, 'contenidos/' + id), contentData);
                closeModal();
                showNotification(id ? 'Contenido actualizado.' : 'Contenido añadido.', 'success');
            } catch (error) {
                console.error("Error al guardar contenido en Firebase:", error);
                showNotification('Error al guardar el contenido.', 'error');
            }
        }
        function addMovieOptionInput(label = '', src = '') { const div = document.createElement('div'); div.className = 'option-group'; div.innerHTML = `<input type="text" placeholder="Etiqueta (ej. Latino)" value="${label}" required><input type="url" placeholder="URL del video" value="${src}" required><button type="button" class="remove-item-btn" title="Eliminar opción"><i class="material-icons">close</i></button>`; document.getElementById('options-list').appendChild(div); div.querySelector('.remove-item-btn').onclick = () => div.remove(); }
        function addSeasonBlock(seasonNumber) { const div = document.createElement('div'); div.className = 'season-block'; div.dataset.seasonNumber = seasonNumber; div.innerHTML = `<div class="season-header"><h3>Temporada ${seasonNumber}</h3><button type="button" class="btn remove-item-btn" style="background:var(--input-bg);">Eliminar Temporada</button></div><div class="episodes-container"></div><button type="button" class="btn add-episode-btn">Añadir Episodio</button>`; document.getElementById('seasons-list').appendChild(div); div.querySelector('.remove-item-btn').onclick = () => div.remove(); div.querySelector('.add-episode-btn').onclick = () => addEpisodeInput(div.querySelector('.episodes-container')); return div; }
        function addEpisodeInput(container, title = '', src = '') { const epCount = container.children.length + 1; const div = document.createElement('div'); div.className = 'episode-group'; div.innerHTML = `<span>Ep.${epCount}</span><input type="text" class="episode-title" placeholder="Título del episodio" value="${title}"><input type="url" class="episode-src" placeholder="URL del episodio" value="${src}"><button type="button" class="remove-item-btn" title="Eliminar episodio"><i class="material-icons">close</i></button>`; container.appendChild(div); div.querySelector('.remove-item-btn').onclick = () => div.remove(); }
        function setTmdbStatus(message, statusType = 'info') { const statusEl = document.getElementById('tmdb-status'); statusEl.className = `status-${statusType}`; let iconHtml = ''; if (statusType === 'loading') iconHtml = '<i class="material-icons spin">sync</i>'; if (statusType === 'success') iconHtml = '<i class="material-icons">check_circle</i>'; if (statusType === 'error') iconHtml = '<i class="material-icons">error</i>'; statusEl.innerHTML = `${iconHtml}<span>${message}</span>`; statusEl.classList.remove('hidden'); }
        async function searchTmdb() { const query = document.getElementById('tmdb-search-input').value.trim(); if (!query) return; setTmdbStatus('Buscando...', 'loading'); document.getElementById('tmdb-results').innerHTML = ''; const url = `https://api.themoviedb.org/3/search/multi?api_key=${TMDB_API_KEY}&language=es-ES&query=${encodeURIComponent(query)}`; try { const response = await fetch(url); if (!response.ok) throw new Error(`TMDB API error: ${response.statusText}`); const data = await response.json(); displayTmdbResults(data.results); } catch (error) { setTmdbStatus('Error en la búsqueda.', 'error'); console.error(error); } }
        function displayTmdbResults(results) { const tmdbResultsContainer = document.getElementById('tmdb-results'); const validResults = results.filter(item => (item.media_type === "movie" || item.media_type === "tv") && item.poster_path); if (validResults.length === 0) { setTmdbStatus('No se encontraron resultados relevantes.', 'info'); return; } validResults.forEach(item => { const resultEl = document.createElement("div"); resultEl.className = "tmdb-result-item"; const title = item.title || item.name; const year = item.release_date || item.first_air_date; resultEl.innerHTML = `<img src="https://image.tmdb.org/t/p/w200${item.poster_path}" alt="${title}" loading="lazy"><span>${title} (${year ? new Date(year).getFullYear() : 'N/A'})</span>`; resultEl.addEventListener('click', () => fetchTmdbDetails(item.id, item.media_type)); tmdbResultsContainer.appendChild(resultEl); }); setTmdbStatus(`${validResults.length} resultados. Haz clic para autocompletar.`, 'info'); }
        async function fetchTmdbDetails(id, type) { setTmdbStatus('Cargando detalles...', 'loading'); document.getElementById('tmdb-results').innerHTML = ''; const url = `https://api.themoviedb.org/3/${type}/${id}?api_key=${TMDB_API_KEY}&language=es-ES&append_to_response=credits,images`; try { const response = await fetch(url); if (!response.ok) throw new Error(`TMDB API error`); const details = await response.json(); populateFormWithTmdb(details, type); if (type === "tv" && details.seasons) { await fetchAndPopulateSeasons(id, details.seasons); } else { setTmdbStatus('¡Éxito! Formulario autocompletado.', 'success'); } } catch (error) { setTmdbStatus('Error al cargar detalles.', 'error'); console.error(error); } }
        function populateFormWithTmdb(details, type) { document.getElementById('type').value = type === 'tv' ? 'series' : 'movie'; document.getElementById('title').value = details.name || details.title || ''; document.getElementById('synopsis').value = details.overview || ''; const releaseDate = details.first_air_date || details.release_date; document.getElementById('year').value = releaseDate ? new Date(releaseDate).getFullYear() : ''; document.getElementById('poster').value = details.poster_path ? `https://image.tmdb.org/t/p/original${details.poster_path}` : ''; document.getElementById('banner').value = details.backdrop_path ? `https://image.tmdb.org/t/p/original${details.backdrop_path}` : (details.images?.backdrops[0]?.file_path ? `https://image.tmdb.org/t/p/original${details.images.backdrops[0].file_path}` : ''); document.getElementById('duration').value = type === 'movie' ? (details.runtime ? `${Math.floor(details.runtime / 60)}h ${details.runtime % 60}m` : '') : ((details.episode_run_time && details.episode_run_time.length > 0) ? `${details.episode_run_time[0]} min/ep` : ''); document.getElementById('rating').value = details.vote_average ? `${details.vote_average.toFixed(1)} / 10` : ''; if (details.genres && details.genres.length > 0) { for (const genre of details.genres) { const mappedValue = genreMap[genre.name]; if (mappedValue) { document.getElementById('category').value = mappedValue; break; } } } toggleFormSections(); }
        async function fetchAndPopulateSeasons(seriesId, seasons) { setTmdbStatus('Cargando episodios...', 'loading'); document.getElementById('seasons-list').innerHTML = ''; const seasonPromises = seasons.filter(s => s.season_number > 0).map(s => fetch(`https://api.themoviedb.org/3/tv/${seriesId}/season/${s.season_number}?api_key=${TMDB_API_KEY}&language=es-ES`).then(res => res.json())); try { const allSeasonsData = await Promise.all(seasonPromises); allSeasonsData.forEach(seasonData => { if (seasonData.episodes && seasonData.episodes.length > 0) { const seasonBlock = addSeasonBlock(seasonData.season_number); const episodesContainer = seasonBlock.querySelector('.episodes-container'); seasonData.episodes.forEach(ep => addEpisodeInput(episodesContainer, ep.name, '')); } }); setTmdbStatus('¡Éxito! Formulario y episodios autocompletados.', 'success'); } catch (error) { setTmdbStatus('Error al cargar episodios.', 'error'); console.error(error); } }

        // --- INICIALIZACIÓN ---
        setupGlobalEventListeners();
        setupFirebaseListener(); // Start listening to Firebase data
    });
</script>

</body>
</html>